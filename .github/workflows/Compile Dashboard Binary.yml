name: Compile Dashboard Binary

on:
  workflow_dispatch:
    inputs:
      nezha_version:
        description: 'Nezha version (e.g., v0.15.17 or master)'
        required: false
        default: 'master'

jobs:
  compile:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout current repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.21'

    - name: Clone Nezha source
      run: |
        echo "Cloning Nezha source..."
        git clone https://github.com/nezhahq/nezha.git nezha-source
        cd nezha-source
        
        # åˆ‡æ¢åˆ°æŒ‡å®šç‰ˆæœ¬
        if [ "${{ github.event.inputs.nezha_version }}" != "master" ]; then
          git checkout ${{ github.event.inputs.nezha_version }}
        fi
        
        echo "Current version:"
        git log -1 --oneline
        
        echo "Source structure:"
        ls -la

    - name: Prepare build environment
      run: |
        cd nezha-source
        
        # ä¸‹è½½Goä¾èµ–
        echo "Downloading Go dependencies..."
        go mod download
        
        # åˆ›å»ºæœ€å°å‰ç«¯èµ„æºï¼ˆé¿å…å‰ç«¯ä¸‹è½½é—®é¢˜ï¼‰
        echo "Creating minimal frontend resources..."
        mkdir -p resource/template
        mkdir -p resource/static
        
        # åˆ›å»ºåŸºæœ¬çš„HTMLæ¨¡æ¿
        cat > resource/template/index.html << 'EOF'
        <!DOCTYPE html>
        <html>
        <head>
            <title>Nezha Dashboard</title>
            <meta charset="utf-8">
        </head>
        <body>
            <h1>Nezha Dashboard</h1>
            <p>Dashboard is running...</p>
        </body>
        </html>
        EOF
        
        echo "Build environment prepared"

    - name: Compile dashboard binary
      run: |
        cd nezha-source
        
        echo "Compiling Nezha Dashboard..."
        
        # è®¾ç½®æ„å»ºä¿¡æ¯
        VERSION=$(git describe --tags --always --dirty 2>/dev/null || echo "dev")
        COMMIT=$(git rev-parse HEAD 2>/dev/null || echo "unknown")
        BUILD_TIME=$(date -u '+%Y-%m-%d_%H:%M:%S')
        
        echo "Build info:"
        echo "  Version: $VERSION"
        echo "  Commit: $COMMIT"
        echo "  Build Time: $BUILD_TIME"
        
        # ç¼–è¯‘dashboard (Linux AMD64)
        echo "Building dashboard binary..."
        CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build \
          -ldflags "-s -w -X github.com/nezhahq/nezha/service/singleton.Version=$VERSION -X github.com/nezhahq/nezha/service/singleton.Commit=$COMMIT -X github.com/nezhahq/nezha/service/singleton.BuildTime=$BUILD_TIME" \
          -o nezha-dashboard \
          ./cmd/dashboard/main.go
        
        # æ£€æŸ¥ç¼–è¯‘ç»“æœ
        if [ -f "nezha-dashboard" ]; then
          echo "âœ… Compilation successful!"
          ls -la nezha-dashboard
          file nezha-dashboard
          echo "Binary size: $(du -h nezha-dashboard | cut -f1)"
        else
          echo "âŒ Compilation failed!"
          exit 1
        fi

    - name: Copy binary to repository
      run: |
        # åˆ›å»ºdashboardç›®å½•
        mkdir -p dashboard
        
        # å¤åˆ¶ç¼–è¯‘å¥½çš„äºŒè¿›åˆ¶æ–‡ä»¶
        cp nezha-source/nezha-dashboard dashboard/app
        chmod +x dashboard/app
        
        echo "âœ… Binary copied to dashboard/app"
        ls -la dashboard/app
        
        # éªŒè¯äºŒè¿›åˆ¶æ–‡ä»¶
        echo "Testing binary..."
        ./dashboard/app --version || echo "Version check completed"

    - name: Commit binary to repository
      run: |
        # é…ç½®git
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # æ·»åŠ äºŒè¿›åˆ¶æ–‡ä»¶
        git add dashboard/app
        
        # æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          # æäº¤å˜åŒ–
          git commit -m "Update dashboard/app binary (nezha ${{ github.event.inputs.nezha_version }})"
          git push
          echo "âœ… Binary committed to repository"
        fi

    - name: Create release info
      run: |
        echo "ğŸ‰ Dashboard binary compilation completed!"
        echo ""
        echo "ğŸ“ Binary location: dashboard/app"
        echo "ğŸ“Š Binary info:"
        ls -la dashboard/app
        file dashboard/app
        echo ""
        echo "ğŸš€ Usage:"
        echo "1. Download the binary:"
        echo "   wget https://github.com/dogwalkerg/nezhadiy/raw/main/dashboard/app"
        echo ""
        echo "2. Make it executable:"
        echo "   chmod +x app"
        echo ""
        echo "3. Run the dashboard:"
        echo "   ./app"
        echo ""
        echo "4. Access dashboard:"
        echo "   http://localhost:8008"
        echo ""
        echo "ğŸ“¦ Source version: ${{ github.event.inputs.nezha_version }}"
        echo "ğŸ•’ Compiled at: $(date)"

    - name: Upload binary as artifact
      uses: actions/upload-artifact@v4
      with:
        name: nezha-dashboard-binary
        path: dashboard/app
        retention-days: 30
